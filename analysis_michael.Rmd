---
title: "analysis_michael"
author: "Michael Wagner"
date: "2023-02-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
rm(list=ls())
library(tidyverse)
library(tseries)
library(forecast)
library(TSA)
library(vars)
```

### load data

```{r}
# set up generalizable path without local path hard coded
base_path <- system('git rev-parse --show-toplevel', intern = T)

# rental index - one for each of four real boroughs
rental_index_raw <- read.csv(paste0(base_path, '/data/rentalIndex_All.csv'))
# median asking rent - four real boroughs + 155 neighborhoods
median_rent_raw <- read.csv(paste0(base_path, '/data/medianAskingRent_All.csv'))
# rental inventory - four real boroughs + 155 neighborhoods
inventory_raw <- read.csv(paste0(base_path, '/data/rentalInventory_All.csv'))

```

### clean and set train / test
```{r}
# rental_index_manhattan <- ts(rental_index_raw$Manhattan,
#                              start=c(2007,1),
#                              frequency=12)


median_rent_manhattan <- median_rent_raw %>% 
  filter(areaName=="Manhattan") %>%
  unlist() %>% as.numeric() %>% 
  na.omit() %>% 
  ts(start=c(2010,1),frequency=12)


inventory_manhattan <- inventory_raw %>% 
  filter(areaName=="Manhattan") %>% 
  unlist() %>% as.numeric() %>% 
  na.omit() %>%
  ts(start=c(2010,1),frequency=12)


rent_train <- window(median_rent_manhattan, start=2010, end=c(2020,1))
inventory_train <- window(inventory_manhattan, start=2010, end=c(2020,1))
rent_test <- window(median_rent_manhattan, start=c(2020,2), end=c(2022,12))
inventory_test <- window(inventory_manhattan, start=c(2020,2), end=c(2022,12))
```

### Trying visualizations and transformations
```{r}
inventory_train %>% autoplot()

# log
log(rent_train) %>%
  cbind(log(inventory_train)) %>%
  autoplot()

#trying transformations
BoxCox(rent_train,lambda='auto') %>% autoplot()
BoxCox(inventory_train,lambda='auto') %>% autoplot()

inventory_train %>% tsdisplay()
#train %>% diff(lag=12, differences = 1) %>% tsdisplay()

BoxCox(inventory_train,lambda='auto') %>% 
  diff(lag=1, differences=1) %>% 
  tsdisplay()
```

### Regression ARMA errors
```{r}
# predict inventory
inventory_arima <- auto.arima(inventory_train, 
                              lambda = 'auto')
inventory_preds <- forecast(inventory_arima, h=24)$mean

# fit model and predict
fit <- auto.arima(rent_train,
                  lambda = 'auto',
                  xreg = inventory_train)

fit %>% summary()
fit %>% checkresiduals()
fit %>% 
  forecast(h=24,
           xreg=inventory_preds) %>% 
  autoplot()
```
### Cross Validation
```{r}
inventory_arima <- auto.arima(inventory_train, 
                              lambda = 'auto')
inventory_preds <- forecast(inventory_arima, h=24)$mean

### DEFINE MODELS HERE:

reg_arma_model = function(rent_train){
  return(auto.arima(rent_train,
                    lambda = 'auto',
                     xreg = inventory_train))}


rent_ets_model = function(training_data){
  return(ets(training_data,model="MAN"))}

fit <- reg_arma_model()



# predict inventory


# fit model and predict
fit <- auto.arima(rent_train,
                  lambda = 'auto',
                  xreg = inventory_train)

fit %>% summary()
fit %>% checkresiduals()
fit %>% 
  forecast(h=24,
           xreg=inventory_preds) %>% 
  autoplot()
```

```{r}
source(paste0(base_path, '/cross_validation.R'))

output_model <- cross.validate(reg_arma_model,rent_train,80,12)
output_ets <- cross.validate(fit,rent_train,80,12)
generate.plots(output_model,output_ets)
```

```{r}
# drews code

# rent
output_model <- cross.validate(rent_SARIMA_model,rent_train,80,12)
output_ets <- cross.validate(rent_ets_model,rent_train,80,12)
generate.plots(output_arima,output_ets)
```



### Attempt at intervention

```{r}

```


