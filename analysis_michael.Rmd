---
title: "analysis_michael"
author: "Michael Wagner"
date: "2023-02-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
rm(list=ls())
library(tidyverse)
library(tseries)
library(forecast)
library(TSA)
library(vars)
library(lubridate)
```

### load data

```{r}
# set up generalizable path without local path hard coded
base_path <- system('git rev-parse --show-toplevel', intern = T)

# rental index - one for each of four real boroughs
rental_index_raw <- read.csv(paste0(base_path, '/data/rentalIndex_All.csv'))
# median asking rent - four real boroughs + 155 neighborhoods
median_rent_raw <- read.csv(paste0(base_path, '/data/medianAskingRent_All.csv'))
# rental inventory - four real boroughs + 155 neighborhoods
inventory_raw <- read.csv(paste0(base_path, '/data/rentalInventory_All.csv'))

```

### clean and set train / test
```{r}
# rental_index_manhattan <- ts(rental_index_raw$Manhattan,
#                              start=c(2007,1),
#                              frequency=12)


median_rent_manhattan <- median_rent_raw %>% 
  filter(areaName=="Manhattan") %>%
  unlist() %>% as.numeric() %>% 
  na.omit() %>% 
  ts(start=c(2010,1),frequency=12)


inventory_manhattan <- inventory_raw %>% 
  filter(areaName=="Manhattan") %>% 
  unlist() %>% as.numeric() %>% 
  na.omit() %>%
  ts(start=c(2010,1),frequency=12)


rent_train <- window(median_rent_manhattan, start=2010, end=c(2020,1))
inventory_train <- window(inventory_manhattan, start=2010, end=c(2020,1))
rent_test <- window(median_rent_manhattan, start=c(2020,2), end=c(2022,12))
inventory_test <- window(inventory_manhattan, start=c(2020,2), end=c(2022,12))
```

### Trying visualizations and transformations
```{r}
inventory_train %>% autoplot()

# log
log(rent_train) %>%
  cbind(log(inventory_train)) %>%
  autoplot()

#trying transformations
BoxCox(rent_train,lambda='auto') %>% autoplot()
BoxCox(inventory_train,lambda='auto') %>% autoplot()

inventory_train %>% tsdisplay()
#train %>% diff(lag=12, differences = 1) %>% tsdisplay()

BoxCox(inventory_train,lambda='auto') %>% 
  diff(lag=1, differences=1) %>% 
  tsdisplay()
```

### Regression ARMA errors
```{r}
# predict inventory
inventory_arima <- auto.arima(inventory_train, 
                              lambda = 'auto')
inventory_preds <- forecast(inventory_arima, h=24)$mean

# fit model and predict
fit <- auto.arima(rent_train,
                  lambda = 'auto',
                  xreg = inventory_train)

fit %>% summary()
fit %>% checkresiduals()
fit %>% 
  forecast(h=24,
           xreg=inventory_preds) %>% 
  autoplot()
```

### Cross Validation
```{r}
# predict inventory
inventory_arima <- auto.arima(inventory_train, 
                              lambda = 'auto')
inventory_preds <- forecast(inventory_arima, h=24)$mean
```

```{r}

exp_error = 0
sl_error = 0
for (i in 1:floor(length(inventory_train) * 0.25)){
  n_sliding <- ceiling(length(inventory_train) * 0.75)
  
  expand_window_inv <- ts(inventory_train[1:n_sliding + i],frequency=12)
  sliding_window_inv <-  ts(inventory_train[i:n_sliding],frequency=12)
  
  expand_window_rent <- ts(rent_train[1:n_sliding + i],frequency=12)
  sliding_window_rent <-  ts(rent_train[i:n_sliding],frequency=12)
  
  test_rent <- ts(rent_train[n_sliding + i: n_sliding + 12],frequency=12)
  test_inv <- ts(inventory_train[n_sliding + i: n_sliding + 12],frequency=12)
}

# fit model 
fit <- auto.arima(rent_train,
                  lambda = 'auto',
                  xreg = inventory_train)

## Create forecast
arma_err_forecast_exp <- forecast(fit,
                                  h=length(test_rent), 
                                  xreg=inventory_preds)

arma_err_forecast_sl <- forecast(fit, h=length(test_rent))$forecast
```

### Attempt at intervention

```{r}
# Calculate the number of observations before the intervention date
num_obs_before <- 122
# Calculate the number of observations after the intervention date
num_obs_after <- 34
# Create a vector of 0s and 1s to represent the intervention variable
intervention_vec <- rep(c(0, 1), c(num_obs_before, num_obs_after))

# Convert the vector to a time series object with the same start and frequency as the AirPassengers data
intervention_ts <- ts(intervention_vec, start = c(2010, 1), frequency = 12)
#xreg_with_intervention <- cbind(inventory_train, intervention_ts)

# fit model and predict
# fit <- auto.arima(median_rent_manhattan,
#                   lambda = 'auto',
#                   xreg = intervention_ts)

#ARIMA(0,1,0)(2,0,0)[12] errors 
fit <- arimax(median_rent_manhattan, 
              order = c(0,1,0),
              seasonal = list(order=c(0,1,1)),
              xreg = intervention_ts)

fit %>% summary()
fit %>% checkresiduals()
fit$
```


